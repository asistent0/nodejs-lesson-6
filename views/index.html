<!DOCTYPE html><html lang="en"><head><meta charset="utf8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>ToDo List</title><link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css"><link rel="stylesheet" href="/bootstrap/dist/css/bootstrap-theme.min.css"><link rel="stylesheet" href="/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css"><!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script><script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--><style>.complete {
    text-decoration: line-through;
}

.user {
    margin: 10px;
    padding: 10px;
}
</style></head></html><body><div class="container"><div class="page-header"><div class="row"><div class="col-md-9"><h1>Todo List</h1></div><div class="col-md-3"><span class="user"><a href="/user" class="btn btn-info">Профиль</a></span><span class="user"><a href="/logout" class="btn btn-warning">Выход</a></span></div></div><div class="todolist"><table class="table table-hover"><tr><th>Выполнено</th><th>Название</th><th>Описание</th><th>Дата создания</th><th>Кнопки</th></tr><tr class="add"><td></td><td><input type="text" placeholder="Название" name="title" class="form-control"></td><td><input type="text" placeholder="Описание" name="description" class="form-control"></td><td><div class="row"><div class="col-sm-12"><input type="text" id="datetimepicker" placeholder="Дата созздания" name="date" class="form-control"></div></div></td><td><button type="button" name="add" class="btn btn-primary"><span class="glyphicon glyphicon-plus"></span></button></td></tr></table></div></div></div><script src="/jquery/dist/jquery.min.js"></script><script src="/bootstrap/dist/js/bootstrap.min.js"></script><script src="/moment/min/moment.min.js"></script><script src="/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script><script>$(function () {
    $('#datetimepicker').datetimepicker();
});

function alertError(msg) {
    $('div.todolist').after('<div class="alert alert-danger"><b>' + msg + '</div>');
    setTimeout(function () {
        $('div.alert').fadeOut('fast')
    }, 3000);
};

// Загружаем задачи
$(document).ready(function () {
    $.post('/', function (data) {
        if (data.status == 'error') {
            return alertError(data.msg);
        }
        $.each(data.todo, function (index, param) {
            var check = '';
            if (param.completed === true) {
                check = 'checked';
            } else {
                check = '';
            }
            $('tr.add')
                    .before('<tr>' +
                            '<td><input type="checkbox" ' + check + ' data-id="' + param._id + '"></td>' +
                            '<td><span data-id="' + param._id + '">' + param.title + '</span></td>' +
                            '<td><span data-id="' + param._id + '">' + param.description + '</span></td>' +
                            '<td><span data-id="' + param._id + '">' + param.date + '</span></td>' +
                            '<td><button type="button" class="btn btn-danger" name="dell" data-id="' +
                            param._id + '">' +
                            '<span class="glyphicon glyphicon-trash"></span></button>' +
                            '<button type="button" class="btn btn-success" name="edit" data-id="' +
                            param._id + '">' +
                            '<span class="glyphicon glyphicon-pencil"></span></button></td>' +
                            '</tr>');
            if (param.completed === true) {
                $('[data-id="' + param._id + '"]').addClass('complete');
            } else {
                $('[data-id="' + param._id + '"]').removeClass('complete');
            }
        });
    }, 'json').fail(function () {
        return alertError('Ошибка подключения к базе данных');
    });

    // Отметка задач об выполнении
    $(document).on('change', 'input:checkbox', function () {
        var id = $(this).data('id');
        $.post('/completed', {
            'id': id
        }, function (data) {
            if (data.status === 'error') {
                return alertError('Сменить значение задачи не удалось' + data.msg);
            }
            if (data.todo.completed) {
                $('[data-id="' + id + '"]').addClass('complete');
            } else {
                $('[data-id="' + id + '"]').removeClass('complete');
            }
        }, 'json').fail(function () {
            return alertError('Ошибка подключения к базе данных');
        });
    });

    // Удаление задач
    $(document).on('click', "button[name='dell']", function () {
        var id = $(this).data('id');
        $.post('/dell', {
            'id': id
        }, function (data) {
            if (data.status === 'error') {
                return alertError('Удалить не удалось' + data.msg);
            }
            if (data.status === 'success') {
                $('[data-id="' + id + '"]').parent('td').parent('tr').remove();
            }
        }, 'json').fail(function () {
            return alertError('Ошибка подключения к базе данных');
        });
    });

    // Редактирование задач
    $(document).on('click', "button[name='edit']", function () {
        var id = $(this).data('id');
        var data = $('span[data-id="' + id + '"]');
        var val0 = $(data[0]).text();
        var val1 = $(data[1]).text();
        var val2 = $(data[2]).text();

        $(data[0]).replaceWith('<input type="text" class="form-control" ' +
                'placeholder="Название" name="title-edit" data-id="' + id + '" value="' + val0 + '">');
        $(data[1]).replaceWith('<input type="text" class="form-control" ' +
                'placeholder="Описание" name="description-edit" data-id="' + id + '" ' +
                'value="' + val1 + '">');
        $(data[2]).replaceWith('<div class="row"><div class="col-sm-12"><input type="text" ' +
                'class="form-control" placeholder="Дата создания" name="date-edit" ' +
                'data-id="' + id + '" value="' + val2 + '" id="datetimepicker1"></div></div>');

        $(function () {
            $('#datetimepicker1').datetimepicker();
        });

        var check = $('input[type="checkbox"][data-id="' + id + '"]');
        $(check[0]).replaceWith('<input type="hidden" data-name="check" data-id="' + id + '">');

        $('button[name="edit"][data-id="' + id + '"]').replaceWith('<button class="btn btn-primary" ' +
                'type="button" name="add-edit" data-id="' + id + '"><span class="glyphicon ' +
                'glyphicon-plus"></span></button>');

        $(document).on('click', "button[name='add-edit'][data-id='" + id + "']", function () {
            var title = $('input[name="title-edit"][data-id="' + id + '"]');
            var description = $('input[name="description-edit"][data-id="' + id + '"]');
            var date = $('input[name="date-edit"][data-id="' + id + '"]');

            $.post('/description', {
                'id': id,
                'title': title.val(),
                'date': date.val(),
                'description': description.val()
            }, function (data) {
                if (data.status === 'error') {
                    return alertError(data.msg);
                }

                $(title).replaceWith('<span data-id="' + data.todo._id + '">' + data.todo.title +
                        '</span>');
                $(description).replaceWith('<span data-id="' + data.todo._id + '">' +
                        data.todo.description + '</span>');
                $(date).replaceWith('<span data-id="' + data.todo._id + '">' + data.todo.date + '</span>');
                $('button[name="add-edit"][data-id="' + id + '"]').replaceWith('<button type="button" ' +
                        'class="btn btn-success" name="edit" data-id="' + data.todo._id + '">' +
                        '<span class="glyphicon glyphicon-pencil"></span></button>');
                $('input[data-name="check"][data-id="' + id + '"]').replaceWith('<input type="checkbox"' +
                        ' data-id="' + data.todo._id + '">');
            }, 'json').fail(function () {
                return alertError('Ошибка подключения к базе данных');
            });
        });
    });

    // Добавление новых задач
    $("button[name='add']").on('click', function () {
        var title = $("input[name='title']");
        var description = $("input[name='description']");
        var date = $("input[name='date']");

        $.post('/add', {
            'title': title.val(),
            'description': description.val(),
            'date': date.val()
        }, function (data) {
            if (data.status === 'error') {
                return alertError(data.msg);
            }
            $('tr.add')
                    .before('<tr>' +
                            '<td><input type="checkbox" data-id="' + data.todo._id + '"></td>' +
                            '<td><span data-id="' + data.todo._id + '">' + data.todo.title + '</span></td>' +
                            '<td><span data-id="' + data.todo._id + '">' + data.todo.description +
                            '</span></td>' +
                            '<td><span data-id="' + data.todo._id + '">' + data.todo.date + '</span></td>' +
                            '<td><button type="button" class="btn btn-danger" name="dell" data-id="' +
                            data.todo._id + '">' +
                            '<span class="glyphicon glyphicon-trash"></span></button>' +
                            '<button type="button" class="btn btn-success" name="edit" data-id="' +
                            data.todo._id + '">' +
                            '<span class="glyphicon glyphicon-pencil"></span></button></td>' +
                            '</tr>');
        }, 'json').fail(function () {
            return alertError('Ошибка подключения к базе данных');
        });

        title.val('');
        description.val('');
        date.val('');
    });
});</script></body>